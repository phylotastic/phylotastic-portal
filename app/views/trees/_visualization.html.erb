<div>
  <!-- <div id="tree-in-newick"></div> -->

  <div id='popup'></div>

  <div class="tree-options-wrapper">
    <!-- First row in tree options -->
    <div class="row">
      <div class="col-sm-3" id="original-tree">
        <input type="radio" name="tree-version" id="original" value="original" checked> <label for="original">Unscaled tree</label>
      </div>
      
      <div class="col-sm-3" id="median-scaled-tree">        
        <%= scaled_tree_state(tree.scaled_median, tree.median_scaled, "scaled_median") %> <label for="scaled_median" data-toggle="tooltip" title="Get tree branch lengths proportional to time with DateLife's median summary method (very fast)">Median scaled</label>
      </div>
      
      <div class="col-sm-3" id="ot-scaled-tree">
        <%= scaled_tree_state(tree.scaled_ot, tree.ot_scaled, "scaled_ot") %> <label for="scaled_ot" data-toggle="tooltip" title="Get tree branch lengths proportional to time from a dated Open Tree of Life (fast)">OT scaled</label>
      </div>
      
      <div class="col-sm-3" id="sdm-scaled-tree">
        <%= scaled_tree_state(tree.scaled_sdm, tree.sdm_scaled, "scaled_sdm") %> <label for="scaled_sdm" data-toggle="tooltip" title="Get tree branch lengths proportional to time with SDM method (very slow, not practical for > 10 tips)">SDM scaled</label>
      </div>
    </div>
    
    <div class="row">
      
      <div class="tree-view-options scaled-tree-options hide">
        <span class="cb-tree-viewer">
          <input type="checkbox" id="branch" class="custom-tree-fields">
        </span>
        <span>
          <label for="branch" data-toggle="tooltip" data-placement="bottom" title="Display branch length of scaling tree">Show branch length</label>
        </span>        
      </div>
      
    </div>
    
    <div class="tree-view-options">
      <span class="cb-tree-viewer">
        <input type="checkbox" id="internal" class="custom-tree-fields">
      </span>
      <span>
        <label for="internal" data-toggle="tooltip" data-placement="bottom" title="Show taxon names associated with internal nodes">iNode labels</label>
      </span>
    </div>

    <div class="tree-view-options">
      <span class="cb-tree-viewer">
        <input type="checkbox" id="ladderize" class="custom-tree-fields">
      </span>
      <span>
        <label for="ladderize" data-toggle="tooltip" data-placement="bottom" title="Rotate nodes to maximize asymmetry (this usually makes the tree easier to read)">Ladderize Tree</label>
      </span>
    </div>
    
    <input type="submit" value="Apply" class="btn btn-primary hide" id="apply-customization">

    <div class="tree-view-options">
      <span>Line weight:</span>
      <span>
        <select name="lwidth" id="line-weight" class="custom-tree-fields">
          <option value="1" selected="selected">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
      </span>
    </div>

    <div class="tree-view-options">
      <span>Line Color:</span>
      <span>
        <input type="color" id="line-color" name="color" value="" size="7"  class="custom-tree-fields">
      </span>
    </div>
    
    <div class="tree-view-options">
      <button class="btn btn-default" onclick="load_tip_images();">Load all images</button>
      <span id="tree_image_message"></span>
    </div>
    
    <div class="tree-view-options">
      <%= link_to "Revert", "#", class: "btn btn-default", id: "revert" %>
    </div>
    
    <div class="tree-view-options">
      <!-- Button dropdown -->
      <div class="dropdown">
        <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
          Export as
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li><a href="#" data-toggle="modal" data-target="#show-tree-format">Text</a></li>
          <li><a href="#" data-toggle="modal" data-target="#show-tree-image">Image</a></li>
        </ul>
      </div>
      
      <!-- Modal -->
      <div class="modal fade" id="show-tree-format" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
              <textarea style="word-break: break-all; min-height: 300px;" id="tree-in-string-format" class="form-control"><%= sanitize_newick(tree) %></textarea>
              <div style="text-align: right; margin-top: 10px;">
                <div style="display: inline; margin-right: 20px;">
                  <%= check_box_tag 'show_ott', '1' %> 
                </div> 
                <label for="show_ott" data-toggle="tooltip" data-placement="top" title="Include the IDs used internally by the OpenTree project" id="copy-to-clipboard">Show OTT ids</span>
              </div>
            </div>
            <div class="modal-footer">
              <div class="btn-group" role="group" aria-label="...">
                <div class="btn-wrapper">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
                <div class="btn-wrapper" id="save-tree-text">
                  <%= link_to "Save", download_tree_path(tree, format: :txt, ott: false), class: "btn btn-primary" %> 
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Modal -->
      <div class="modal fade" id="show-tree-image" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <p><em>* Disable popup blocker in this brower to be redirected to image </em></p>
            </div>
            <div class="modal-body">
    
              <div class="row">
                <div class="col-md-3">Image format: </div>
                <div class="col-md-9">
                  <div class="row">
                    <div class="col-md-2">
                      <input type="radio" name="format" value="png" checked="checked"> png
                    </div>
                    <div class="col-md-2">
                      <input type="radio" name="format" value="svg"> svg
                    </div>
                    <div class="col-md-8">
                      <a href="#" onclick="save_tree_image();" class="btn btn-primary" style="margin-right: 20px;">Generate link to download</a>
                    </div>
                  </div>
                  <div id="svg_image" class=""></div>
                </div>
              </div>
    
            </div>
            <div class="modal-footer">
              <div class="btn-wrapper">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
            </div>
  
          </div>
        </div>
      </div>
    </div>
    
  </div>
  
  <%= form_for tree, url: { action: "update" }, remote: true, html: {id: "tree_state_form", class: "hide"} do |f| %>
    <%= f.hidden_field :action_sequence, id: "tree_state" %><br />
  <% end %>
  
  <!-- Display information -->
  <% leaves = NewickTree.new(@tree.unscaled.to_s).root.leaves.count rescue 'undetermined' %>
  <div class="row">
    <div class="alert alert-warning alert-dismissible col-md-6 col-md-offset-3" role="alert">
      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      Retrieved a tree with <strong><%= leaves %></strong> tips. <strong><%= @tree.chosen_species.count %></strong> of <strong><%= JSON.parse(@tree.species).count %></strong> taxa in the input list were matched.
    </div>
  </div>
  
  <div id='img1' class="ete_image"></div>


  <div>
    <div class="pull-right" style="font-size: 80%;">
      Last edited: <%= time_ago_in_words(tree.updated_at) %> ago.
    </div>
  </div>

</div>
<!-- End of tree content tab -->


<div class="modal fade" id="tree-hint" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        Click on a name or a node to see viewer options. More info is available in the "Tree Viewer" section of Help.
      </div>
      <div class="modal-footer">
        <div class="btn-group" role="group" aria-label="...">
          <div class="btn-wrapper">
            <button type="button" class="btn btn-default btn-primary" data-dismiss="modal" id="gotit">Got it</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="tree-rendering-failed" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body">
        Sorry! We got a tree (you can click "Export" to save the tree to your machine) but there was an error trying to visualize it. Try another tree, and use <%= link_to "Feedback", static_pages_feedback_path %> to report any errors.
      </div>
      <div class="modal-footer">
        <div class="btn-group" role="group" aria-label="...">
          <div class="btn-wrapper">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <%= link_to "Feedback", static_pages_feedback_path, class: "btn btn-default btn-primary" %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script type="text/javascript">
$(document).ready(function() {
  
  if(Cookies.get("view_hint") == "true") {
    $('#tree-hint').modal();
  }

  $("#gotit").click(function() {
    Cookies.set("view_hint", "false");
  });

  $('#apply-customization').click(function() {
    run_tree_action();
  })

  $('.custom-tree-fields').change(function() {
    $('#apply-customization').click();
  })

  // $('#display-scaled-tree').click(function() {
  //   <% if @tree.sdm_scaled.empty? %>
  //     $('#scale-tree').modal();
  //   <% else %>
  //     current_tree_newick = "<%= @tree.sdm_scaled %>";
  //     run_tree_action();
  //     $('#display-original-tree').removeClass('hide');
  //     $('.scaled-tree-options').removeClass('hide');
  //     $(this).addClass('hide');
  //   <% end %>
  // });
  //
  // $('#display-original-tree').click(function() {
  //   current_tree_newick = "<%= @tree.unscaled %>";
  //   $('#branch').prop('checked', false);
  //   run_tree_action();
  //   $('#display-scaled-tree').removeClass('hide');
  //   $('.scaled-tree-options').addClass('hide');
  //   $(this).addClass('hide');
  // });
  
  $('#revert').click(function() {
    $('#internal').prop('checked', false);
    $('#ladderize').prop('checked', false);
    $('#branch').prop('checked', false);
    $('#line-color').val('#787878');
    // $('#line-weight option[value="1"]').attr("selected", "selected");
    $('#line-weight').val("1");
    run_tree_action();
  });

  $('#show_ott').change(function() {
    if($(this).is(':checked')) {
      $('#tree-in-string-format').val("<%= tree.unscaled %>");
      $('#save-tree-text').html('<%= link_to "Save", download_tree_path(format: :txt, id: tree.id, ott: true), class: "btn btn-primary" %>');
    } else {
      $('#tree-in-string-format').val("<%= sanitize_newick(tree) %>");
      $('#save-tree-text').html('<%= link_to "Save", download_tree_path(format: :txt, id: tree.id, ott: false), class: "btn btn-primary" %>');   
    }
  })
  
})


</script>